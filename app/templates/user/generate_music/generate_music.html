<!-- PBL6/app/templates/user/generate_music/generate_music.html -->

{% extends 'user/layout.html' %}

{% block user_content %}
    <style>
        .chat-container {
            max-width: 1200px; /* TƒÉng k√≠ch th∆∞·ªõc t·ª´ 600px l√™n 800px */
            margin: 50px auto;
            padding: 30px; /* TƒÉng padding ƒë·ªÉ giao di·ªán tho√°ng h∆°n */
            border: 1px solid #ddd;
            border-radius: 20px; /* Bo g√≥c l·ªõn h∆°n */
            background-color: #fff;
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        .chat-header {
            text-align: center;
            margin-bottom: 25px; /* TƒÉng kho·∫£ng c√°ch d∆∞·ªõi header */
        }
        .chat-messages {
            height: 500px; /* TƒÉng chi·ªÅu cao c·ªßa khung chat */
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 25px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 10px; /* T·∫°o kho·∫£ng c√°ch gi·ªØa c√°c tin nh·∫Øn */
        }
        .message {
            display: flex;
            align-items: flex-start;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message.bot {
            justify-content: flex-start;
        }
        .message.user .text {
            background-color: #d1e7dd;
            align-self: flex-end;
            text-align: right;
        }
        .message.bot .text {
            background-color: #e2e3e5;
            align-self: flex-start;
            text-align: left;
        }
        .text {
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 75%;
            display: inline-block;
            position: relative;
        }
        .message.bot .text::before {
            content: "";
            position: absolute;
            top: 10px;
            left: -10px;
            border-width: 10px;
            border-style: solid;
            border-color: transparent #e2e3e5 transparent transparent;
        }
        .message.user .text::before {
            content: "";
            position: absolute;
            top: 10px;
            right: -10px;
            border-width: 10px;
            border-style: solid;
            border-color: transparent transparent transparent #d1e7dd;
        }
        .chat-input {
            display: flex;
        }
        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
            font-size: 16px;
        }
        .chat-input button {
            padding: 12px 24px;
            border: 1px solid #ddd;
            border-left: none;
            background-color: #007bff;
            color: #fff;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            font-size: 16px;
        }
        .chat-input button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
        .bot-icon {
            margin-right: 10px;
            width: 24px;
            height: 24px;
            vertical-align: middle;
        }
        /* ƒê·∫£m b·∫£o audio player v√† n√∫t t·∫£i v·ªÅ hi·ªÉn th·ªã ƒë√∫ng trong chat */
        .audio-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .audio-container audio {
            flex: 1;
        }
    </style>

    <div class="chat-container">
        <div class="chat-header">
            <h3>T·∫°o √¢m nh·∫°c theo phong c√°ch ri√™ng b·∫°n</h3>
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
        </div>
        <div class="chat-input">
            <input type="text" id="music-request" class="form-control" placeholder="Nh·∫≠p y√™u c·∫ßu b√†i h√°t c·ªßa b·∫°n...">
            <button id="send-button" class="btn btn-primary">G·ª≠i</button>
        </div>
        <div class="mt-3" id="status-message" style="display: none;">
            <div class="d-flex align-items-center">
                <div class="spinner-border text-primary me-2" role="status">
                    <span class="visually-hidden">ƒêang t·∫°o...</span>
                </div>
                <span>ƒêang t·∫°o √¢m nh·∫°c...</span>
            </div>
        </div>
    </div>

    <!-- Modal chia s·∫ª v√† c√°c modals kh√°c ·ªü ƒë√¢y (n·∫øu c·∫ßn) -->
    <script>
        $(document).ready(function() {
            console.log("JavaScript ƒë√£ ƒë∆∞·ª£c t·∫£i v√† document ready.");

            // Cu·ªôn xu·ªëng d∆∞·ªõi c√πng c·ªßa khung chat
            function scrollToBottom() {
                var chat = $('#chat-messages');
                chat.scrollTop(chat[0].scrollHeight);
                console.log("Cu·ªôn xu·ªëng d∆∞·ªõi c√πng c·ªßa khung chat.");
            }

            // SVG Icon c·ªßa Bot (SVG t√πy ch·ªânh b·∫°n ƒë√£ cung c·∫•p)
            const botSVGIcon = `
                <svg width="24px" height="24px" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
                    <path d="M213.333333 554.666667m-85.333333 0a85.333333 85.333333 0 1 0 170.666667 0 85.333333 85.333333 0 1 0-170.666667 0Z" fill="#FFA726" />
                    <path d="M810.666667 554.666667m-85.333334 0a85.333333 85.333333 0 1 0 170.666667 0 85.333333 85.333333 0 1 0-170.666667 0Z" fill="#FFA726" />
                    <path d="M832 405.333333c0-270.933333-640-177.066667-640 0v213.333334c0 177.066667 142.933333 320 320 320s320-142.933333 320-320V405.333333z" fill="#FFB74D" />
                    <path d="M512 64C311.466667 64 149.333333 226.133333 149.333333 426.666667v72.533333L192 533.333333v-64l448-209.066666 192 209.066666v64l42.666667-34.133333V426.666667c0-170.666667-121.6-362.666667-362.666667-362.666667z" fill="#FF5722" />
                    <path d="M661.333333 554.666667m-42.666666 0a42.666667 42.666667 0 1 0 85.333333 0 42.666667 42.666667 0 1 0-85.333333 0Z" fill="#784719" />
                    <path d="M362.666667 554.666667m-42.666667 0a42.666667 42.666667 0 1 0 85.333333 0 42.666667 42.666667 0 1 0-85.333333 0Z" fill="#784719" />
                    <path d="M917.333333 512c-12.8 0-21.333333 8.533333-21.333333 21.333333v-149.333333c0-187.733333-153.6-341.333333-341.333333-341.333333h-149.333334c-12.8 0-21.333333 8.533333-21.333333 21.333333s8.533333 21.333333 21.333333 21.333333h149.333334c164.266667 0 298.666667 134.4 298.666666 298.666667v213.333333c0 12.8 8.533333 21.333333 21.333334 21.333334s21.333333-8.533333 21.333333-21.333334v42.666667c0 83.2-66.133333 149.333333-149.333333 149.333333H512c-12.8 0-21.333333 8.533333-21.333333 21.333334s8.533333 21.333333 21.333333 21.333333h234.666667c106.666667 0 192-85.333333 192-192v-106.666667c0-12.8-8.533333-21.333333-21.333334-21.333333z" fill="#757575" />
                    <path d="M917.333333 469.333333h-21.333333c-23.466667 0-42.666667 19.2-42.666667 42.666667v85.333333c0 23.466667 19.2 42.666667 42.666667 42.666667h21.333333c23.466667 0 42.666667-19.2 42.666667-42.666667v-85.333333c0-23.466667-19.2-42.666667-42.666667-42.666667z" fill="#37474F" />
                    <path d="M512 810.666667m-42.666667 0a42.666667 42.666667 0 1 0 85.333334 0 42.666667 42.666667 0 1 0-85.333334 0Z" fill="#37474F" />
                </svg>
            `;

            // Hi·ªÉn th·ªã tin nh·∫Øn t·ª´ bot v·ªõi hi·ªáu ·ª©ng g√µ t·ª´ng k√Ω t·ª±
            function addBotMessage(message, isSuccess = false, audioURL = '') {
                console.log("Th√™m tin nh·∫Øn t·ª´ bot:", message);
                const botMessage = $(`
                    <div class="message bot">
                        <div class="text">
                            ${botSVGIcon}<span class="bot-text"></span>
                        </div>
                    </div>
                `);
                $('#chat-messages').append(botMessage);
                scrollToBottom();

                // Hi·ªáu ·ª©ng g√µ t·ª´ng k√Ω t·ª± v·ªõi t·ªëc ƒë·ªô nhanh h∆°n (v√≠ d·ª•: 30ms)
                let index = 0;
                function typeCharacter() {
                    if (index < message.length) {
                        botMessage.find('.bot-text').append(message.charAt(index));
                        index++;
                        // T·ªëc ƒë·ªô g√µ k√Ω t·ª±: 30ms
                        setTimeout(typeCharacter, 30);
                    } else if (isSuccess && audioURL) {
                        // Sau khi ho√†n th√†nh g√µ, th√™m ph·∫ßn √¢m nh·∫°c v√† n√∫t t·∫£i v·ªÅ
                        const audioContent = `
                            <div class="audio-container mt-2">
                                <audio controls>
                                    <source src="${audioURL}" type="audio/wav">
                                    Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ th·∫ª audio.
                                </audio>
                                <a href="${audioURL}" download="custom_music.wav" class="btn btn-success">T·∫£i xu·ªëng</a>
                            </div>
                        `;
                        botMessage.find('.bot-text').append(audioContent);
                        scrollToBottom();
                    }
                }
                typeCharacter();
            }

            // Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng
            function addUserMessage(message) {
                console.log("Th√™m tin nh·∫Øn t·ª´ ng∆∞·ªùi d√πng:", message);
                $('#chat-messages').append(`
                    <div class="message user">
                        <div class="text">${message}</div>
                    </div>
                `);
                scrollToBottom();
            }

            // Hi·ªÉn th·ªã tin nh·∫Øn kh·ªüi ƒë·∫ßu khi trang t·∫£i v·ªõi hi·ªáu ·ª©ng g√µ t·ª´ng k√Ω t·ª±
            const welcomeMessage = "Xin ch√†o! üëã\nT√¥i l√† MusicGen AI, m·ªôt m√¥ h√¨nh tr√≠ tu·ªá nh√¢n t·∫°o ƒë∆∞·ª£c thi·∫øt k·∫ø b·ªüi ƒë·ªôi ng≈© FAIR c·ªßa Meta AI. T√¥i ƒë∆∞·ª£c t·∫°o ra ƒë·ªÉ gi√∫p m·ªçi ng∆∞·ªùi s√°ng t·∫°o v√† kh√°m ph√° √¢m nh·∫°c theo c√°ch ƒë∆°n gi·∫£n v√† tr·ª±c quan nh·∫•t.";
            addBotMessage(welcomeMessage);

            $('#send-button').click(function() {
                console.log("N√∫t g·ª≠i ƒë∆∞·ª£c nh·∫•n.");
                const text = $('#music-request').val().trim();
                if (text === "") {
                    alert("Vui l√≤ng nh·∫≠p y√™u c·∫ßu b√†i h√°t c·ªßa b·∫°n!");
                    return;
                }

                // Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng
                addUserMessage(text);
                $('#music-request').val("");

                // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫°o √¢m nh·∫°c
                $('#status-message').show();

                // G·ª≠i y√™u c·∫ßu ƒë·∫øn backend c·ªïng 8000
                axios.post('http://localhost:8000/generate-music', { text: text }, {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    responseType: 'blob' // Quan tr·ªçng ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu nh·ªã ph√¢n
                })
                    .then(response => {
                        // T·∫°o URL cho t·ªáp tin √¢m thanh
                        const url = window.URL.createObjectURL(new Blob([response.data], { type: 'audio/wav' }));
                        console.log(url);

                        // ·∫®n tr·∫°ng th√°i ƒëang t·∫°o
                        $('#status-message').hide();

                        // Hi·ªÉn th·ªã tin nh·∫Øn t·ª´ chatbot v·ªõi ph·∫ßn √¢m nh·∫°c v√† n√∫t t·∫£i v·ªÅ
                        const successMessage = "√Çm nh·∫°c ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ nghe v√† t·∫£i xu·ªëng t·∫°i ƒë√¢y.";
                        addBotMessage(successMessage, true, url);
                    })
                    .catch(error => {
                        console.error('Error generating music:', error);
                        $('#status-message').hide();
                        alert('ƒê√£ x·∫£y ra l·ªói khi t·∫°o √¢m nh·∫°c: ' + (error.response && error.response.data ? 'C√≥ th·ªÉ API kh√¥ng ph·∫£n h·ªìi ƒë√∫ng c√°ch.' : error.message));
                    });
            });

            // G·ª≠i y√™u c·∫ßu khi nh·∫•n Enter
            $('#music-request').keypress(function(e) {
                if (e.which === 13) { // Enter key pressed
                    console.log("Nh·∫•n Enter ƒë·ªÉ g·ª≠i y√™u c·∫ßu.");
                    $('#send-button').click();
                }
            });
        });
    </script>
{% endblock %}
